<div class="admin-contacts-page">
  <div class="page-header">
    <div class="header-title-section">
      <h1>Gestion des contacts</h1>
      <p class="subtitle">Demandes de contact et rendez-vous</p>
    </div>
    <div class="header-stats">
      @if (unreadCount > 0) {
        <div class="stat-badge">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
          </svg>
          <span>{{ unreadCount }} non lu{{ unreadCount > 1 ? 's' : '' }}</span>
        </div>
      }
    </div>
  </div>

  <!-- Filtres -->
  <div class="filters">
    <div class="filter-group">
      <label>Filtrer par statut :</label>
      <select [(ngModel)]="filterRead" (change)="filterRead = filterRead">
        <option value="all">Tous</option>
        <option value="unread">Non lus</option>
        <option value="read">Lus</option>
      </select>
    </div>
  </div>

  <!-- Liste des contacts -->
  @if (loading && contactsList.length === 0) {
    <div class="loading-state">
      <p>Chargement...</p>
    </div>
  }

  @if (error && contactsList.length === 0) {
    <div class="error-state">
      <p>{{ error }}</p>
    </div>
  }

  <div class="contacts-list">
    @for (contact of filteredContacts; track contact) {
      <div
        class="contact-card"
        [class.unread]="!contact.read"
        (click)="viewContact(contact)">
        <div class="contact-header">
          <div class="contact-info-main">
            <div class="contact-name-email">
              <h3>{{ contact.name }}</h3>
              <span class="contact-email">{{ contact.email }}</span>
            </div>
            <div class="contact-meta">
              <span class="contact-subject">{{ getSubjectLabel(contact.subject) }}</span>
              <span class="contact-date">{{ formatDate(contact.createdAt) }}</span>
            </div>
          </div>
          <div class="contact-actions">
            <span class="read-badge" [class.read]="contact.read" [class.unread]="!contact.read">
              {{ contact.read ? 'Lu' : 'Non lu' }}
            </span>
            <button
              class="btn-icon"
              (click)="contact.read ? markAsUnread(contact.id!) : markAsRead(contact.id!); $event.stopPropagation()"
              [title]="contact.read ? 'Marquer comme non lu' : 'Marquer comme lu'"
              [disabled]="loading">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
            </button>
            <button
              class="btn-icon btn-danger"
              (click)="deleteContact(contact.id!); $event.stopPropagation()"
              title="Supprimer"
              [disabled]="loading">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
              </svg>
            </button>
          </div>
        </div>
        <div class="contact-preview">
          <p>{{ contact.message.length > 100 ? (contact.message.substring(0, 100) + '...') : contact.message }}</p>
        </div>
        @if (contact.phone) {
          <div class="contact-footer">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
            </svg>
            <span>{{ contact.phone }}</span>
          </div>
        }
      </div>
    }

    @if (!loading && filteredContacts.length === 0) {
      <div class="empty-state">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
          <polyline points="22,6 12,13 2,6"/>
        </svg>
        <p>Aucun contact pour le moment</p>
      </div>
    }
  </div>

  <!-- Modal de détail -->
  @if (showModal) {
    <div class="modal-overlay" (click)="closeModal()">
      @if (selectedContact) {
        <div class="modal-content" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h2>Détails du contact</h2>
            <button class="btn-icon" (click)="closeModal()" [disabled]="loading">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
            </button>
          </div>
          <div class="modal-body">
            <div class="detail-group">
              <label>Nom</label>
              <p>{{ selectedContact.name }}</p>
            </div>
            <div class="detail-group">
              <label>Email</label>
              <p><a [href]="'mailto:' + selectedContact.email">{{ selectedContact.email }}</a></p>
            </div>
            @if (selectedContact.phone) {
              <div class="detail-group">
                <label>Téléphone</label>
                <p><a [href]="'tel:' + selectedContact.phone">{{ selectedContact.phone }}</a></p>
              </div>
            }
            <div class="detail-group">
              <label>Sujet</label>
              <p>{{ getSubjectLabel(selectedContact.subject) }}</p>
            </div>
            <div class="detail-group">
              <label>Date</label>
              <p>{{ formatDate(selectedContact.createdAt) }}</p>
            </div>
            <div class="detail-group">
              <label>Message</label>
              <div class="message-content">{{ selectedContact.message }}</div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              class="btn btn-secondary"
              (click)="selectedContact.read ? markAsUnread(selectedContact.id!) : markAsRead(selectedContact.id!)"
              [disabled]="loading">
              {{ selectedContact.read ? 'Marquer comme non lu' : 'Marquer comme lu' }}
            </button>
            <button
              class="btn btn-danger"
              (click)="deleteContact(selectedContact.id!); closeModal()"
              [disabled]="loading">
              Supprimer
            </button>
          </div>
        </div>
      }
    </div>
  }
</div>

