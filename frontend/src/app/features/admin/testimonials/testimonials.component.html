<div class="admin-testimonials-page">
    <div class="page-header">
      <h1>Gestion des témoignages</h1>
      <div class="header-actions">
        <button class="btn btn-primary" (click)="openAddModal('text')">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          </svg>
          Ajouter un témoignage écrit
        </button>
        <button class="btn btn-secondary" (click)="openAddModal('video')">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="5 3 19 12 5 21 5 3"/>
          </svg>
          Ajouter une vidéo
        </button>
      </div>
    </div>

    <!-- Liste des témoignages -->
      <div class="loading-state" *ngIf="loading && testimonialsList.length === 0">
        <p>Chargement...</p>
      </div>

      <div class="error-state" *ngIf="error && testimonialsList.length === 0">
        <p>{{ error }}</p>
      </div>

      <div class="testimonials-list">
      <div class="testimonial-card" *ngFor="let testimonial of testimonialsList; let i = index">
        <div class="testimonial-content">
          <div class="testimonial-header">
            <div class="testimonial-rating">
              <svg *ngFor="let star of [1,2,3,4,5]" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
              </svg>
            </div>
            <div class="testimonial-actions">
              <button class="btn-icon" (click)="editTestimonial(i)" title="Modifier" [disabled]="loading">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
              </button>
              <button class="btn-icon btn-danger" (click)="deleteTestimonial(i)" title="Supprimer" [disabled]="loading">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"/>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
              </button>
            </div>
          </div>
          <p class="testimonial-quote" *ngIf="testimonial?.quote">"{{ testimonial.quote }}"</p>
          <div class="testimonial-video" *ngIf="testimonial?.videoUrl">
            <div class="video-badge">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="5 3 19 12 5 21 5 3"/>
              </svg>
              <span>{{ testimonial.quote ? 'Vidéo disponible' : 'Vidéo seule' }}</span>
            </div>
          </div>
          <div class="testimonial-author" *ngIf="testimonial?.author">
            <strong>{{ testimonial.author }}</strong>
            <span *ngIf="testimonial.role || testimonial.company">
              <span *ngIf="testimonial.role">{{ testimonial.role }}</span>
              <span *ngIf="testimonial.role && testimonial.company">, </span>
              <span *ngIf="testimonial.company">{{ testimonial.company }}</span>
            </span>
          </div>
          <div class="testimonial-video-only" *ngIf="!testimonial?.author && testimonial?.videoUrl">
            <p class="video-only-label">Témoignage vidéo uniquement</p>
          </div>
        </div>
      </div>

      <div class="empty-state" *ngIf="!loading && testimonialsList.length === 0">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
        </svg>
        <p>Aucun témoignage pour le moment</p>
        <p class="empty-state-hint">Utilisez les boutons ci-dessus pour ajouter votre premier témoignage</p>
      </div>
    </div>

  <!-- Modal pour ajouter/modifier -->
  <div class="modal-overlay" *ngIf="showModal" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ editingTestimonial ? 'Modifier le témoignage' : (testimonialMode === 'video' ? 'Ajouter une vidéo' : 'Ajouter un témoignage écrit') }}</h2>
        <button class="btn-icon" (click)="closeModal()" [disabled]="loading">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      
      <!-- Onglets pour choisir le type -->
      <div class="modal-tabs" *ngIf="!editingTestimonial">
        <button 
          type="button"
          class="tab-btn" 
          [class.active]="testimonialMode === 'text'"
          (click)="testimonialMode = 'text'">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          </svg>
          Témoignage écrit
        </button>
        <button 
          type="button"
          class="tab-btn" 
          [class.active]="testimonialMode === 'video'"
          (click)="testimonialMode = 'video'">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="5 3 19 12 5 21 5 3"/>
          </svg>
          Vidéo seule
        </button>
      </div>

      <form class="modal-body" (ngSubmit)="saveTestimonial()" *ngIf="!loading">
        <div class="error-message" *ngIf="error">{{ error }}</div>
        
        <!-- Mode Vidéo -->
        <div *ngIf="testimonialMode === 'video'">
          <div class="form-group">
            <label for="videoUrl">Vidéo *</label>
            <p class="form-info">Uploader une vidéo depuis votre ordinateur ou fournir une URL YouTube/Vimeo</p>
            
            <!-- Option 1: Upload depuis le desktop -->
          <div class="video-upload-section">
            <label class="upload-label" for="videoFile">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
              <span *ngIf="!uploadingVideo">Télécharger une vidéo depuis votre ordinateur</span>
              <span *ngIf="uploadingVideo">Upload en cours...</span>
            </label>
            <input 
              type="file" 
              id="videoFile" 
              accept="video/*"
              (change)="onVideoFileSelected($event)"
              [disabled]="uploadingVideo"
              style="display: none;">
            <small class="form-hint">Formats acceptés: MP4, WebM, OGG, MOV, AVI (max 100MB)</small>
          </div>

          <!-- Séparateur -->
          <div class="video-separator">
            <span>OU</span>
          </div>

          <!-- Option 2: URL externe -->
          <div class="video-url-section">
            <input 
              type="url" 
              id="videoUrl" 
              [(ngModel)]="formData.videoUrl" 
              name="videoUrl" 
              placeholder="https://www.youtube.com/watch?v=... ou https://youtu.be/..."
              [disabled]="isUploadedVideo(formData.videoUrl)">
            <small class="form-hint">URL YouTube, Vimeo ou autre plateforme vidéo</small>
          </div>

          <!-- Aperçu de la vidéo -->
          <div class="video-preview" *ngIf="formData.videoUrl && !uploadingVideo">
            <div class="video-preview-header">
              <span>Vidéo sélectionnée</span>
              <button type="button" class="btn-remove-video" (click)="removeVideo()" title="Supprimer la vidéo">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </button>
            </div>
            <div class="video-preview-content">
              <!-- Vidéo uploadée -->
              <video *ngIf="isUploadedVideo(formData.videoUrl)" controls [src]="formData.videoUrl" class="preview-video">
                Votre navigateur ne supporte pas la lecture de vidéos.
              </video>
              <!-- URL externe -->
              <div *ngIf="isExternalVideoUrl(formData.videoUrl)" class="video-url-preview">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polygon points="5 3 19 12 5 21 5 3"/>
                </svg>
                <span>{{ formData.videoUrl }}</span>
              </div>
            </div>
          </div>
          </div>
        </div>

        <!-- Mode Témoignage écrit -->
        <div *ngIf="testimonialMode === 'text'">
          <div class="form-group">
            <label for="quote">Citation *</label>
            <textarea id="quote" [(ngModel)]="formData.quote" name="quote" rows="4" required></textarea>
            <small class="form-hint">Minimum 10 caractères</small>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="author">Auteur *</label>
              <input type="text" id="author" [(ngModel)]="formData.author" name="author" required>
            </div>
            <div class="form-group">
              <label for="role">Rôle *</label>
              <input type="text" id="role" [(ngModel)]="formData.role" name="role" required>
            </div>
          </div>
          <div class="form-group">
            <label for="company">Entreprise *</label>
            <input type="text" id="company" [(ngModel)]="formData.company" name="company" required>
          </div>
          <div class="form-group">
            <label for="rating">Note (1-5) *</label>
            <select id="rating" [(ngModel)]="formData.rating" name="rating" required>
              <option [ngValue]="1">1 étoile</option>
              <option [ngValue]="2">2 étoiles</option>
              <option [ngValue]="3">3 étoiles</option>
              <option [ngValue]="4">4 étoiles</option>
              <option [ngValue]="5">5 étoiles</option>
            </select>
          </div>
          
          <!-- Option vidéo pour témoignage écrit (optionnel) -->
          <div class="form-group">
            <label for="videoUrlText">Vidéo (optionnel)</label>
            <p class="form-info">Vous pouvez également ajouter une vidéo en complément du témoignage écrit</p>
            
            <div class="video-upload-section">
              <label class="upload-label" for="videoFileText">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="17 8 12 3 7 8"></polyline>
                  <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <span *ngIf="!uploadingVideo">Télécharger une vidéo</span>
                <span *ngIf="uploadingVideo">Upload en cours...</span>
              </label>
              <input 
                type="file" 
                id="videoFileText" 
                accept="video/*"
                (change)="onVideoFileSelected($event)"
                [disabled]="uploadingVideo"
                style="display: none;">
            </div>

            <div class="video-url-section">
              <input 
                type="url" 
                id="videoUrlText" 
                [(ngModel)]="formData.videoUrl" 
                name="videoUrlText" 
                placeholder="https://www.youtube.com/watch?v=... ou https://youtu.be/..."
                [disabled]="isUploadedVideo(formData.videoUrl)">
            </div>

            <div class="video-preview" *ngIf="formData.videoUrl && !uploadingVideo">
              <div class="video-preview-header">
                <span>Vidéo sélectionnée</span>
                <button type="button" class="btn-remove-video" (click)="removeVideo()">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                </button>
              </div>
              <div class="video-preview-content">
                <video *ngIf="isUploadedVideo(formData.videoUrl)" controls [src]="formData.videoUrl" class="preview-video"></video>
                <div *ngIf="isExternalVideoUrl(formData.videoUrl)" class="video-url-preview">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="5 3 19 12 5 21 5 3"/>
                  </svg>
                  <span>{{ formData.videoUrl }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeModal()" [disabled]="loading">Annuler</button>
          <button type="submit" class="btn btn-primary" [disabled]="loading">
            <span *ngIf="loading">Enregistrement...</span>
            <span *ngIf="!loading">Enregistrer</span>
          </button>
        </div>
      </form>
      <div class="loading-state" *ngIf="loading">
        <p>Enregistrement en cours...</p>
      </div>
    </div>
  </div>
</div>

