<div class="placement-tests-page">
  <div class="page-header">
    <h1>Tests de positionnement</h1>
    <button class="btn btn-primary" (click)="createTest()" [disabled]="loading">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 5v14M5 12h14"/>
      </svg>
      Créer un test
    </button>
  </div>

  <div class="success-message" *ngIf="successMessage">{{ successMessage }}</div>
  <div class="error-message" *ngIf="error">{{ error }}</div>

  <div class="loading-state" *ngIf="loading && tests.length === 0">
    <p>Chargement des tests...</p>
  </div>

  <div class="tests-list" *ngIf="!loading || tests.length > 0">
    <div class="test-card" *ngFor="let test of tests">
      <div class="test-header">
        <div class="test-info">
          <h3>{{ test.title }}</h3>
          <span class="test-course" *ngIf="test.course">{{ test.course.title }}</span>
          <div class="test-meta">
            <span>Score minimum: {{ test.passingScore }}%</span>
            <span>Durée: {{ test.timeLimit }} min</span>
            <span class="badge" [class.active]="test.isActive" [class.inactive]="!test.isActive">
              {{ test.isActive ? 'Actif' : 'Inactif' }}
            </span>
          </div>
        </div>
        <div class="test-actions">
          <button class="btn-icon" (click)="editTest(test)" title="Modifier">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </svg>
          </button>
          <button class="btn-icon btn-danger" (click)="deleteTest(test)" title="Supprimer">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3 6 5 6 21 6"/>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            </svg>
          </button>
        </div>
      </div>

      <div class="test-questions" *ngIf="test.questions && test.questions.length > 0">
        <div class="questions-header">
          <h4>Questions ({{ test.questions.length }})</h4>
          <button class="btn btn-small" (click)="addQuestion(test)">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 5v14M5 12h14"/>
            </svg>
            Ajouter une question
          </button>
        </div>

        <div class="question-item" *ngFor="let question of test.questions; let qIndex = index">
          <div class="question-header">
            <span class="question-number">Q{{ qIndex + 1 }}</span>
            <p class="question-text">{{ question.question }}</p>
            <div class="question-actions">
              <button class="btn-icon btn-small" (click)="editQuestion(question)" title="Modifier">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
              </button>
              <button class="btn-icon btn-small btn-danger" (click)="deleteQuestion(question)" title="Supprimer">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"/>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
              </button>
            </div>
          </div>

          <div class="answers-list" *ngIf="question.answers && question.answers.length > 0">
            <div class="answer-item" *ngFor="let answer of getQuestionAnswers(question); let aIndex = index; trackBy: trackByAnswerId">
              <span class="answer-label">{{ getAnswerLabel(aIndex) }}.</span>
              <span class="answer-text">{{ answer.text || 'Chargement...' }}</span>
              <span class="answer-score" *ngIf="answer.score !== undefined">Score: {{ answer.score }}</span>
              <span class="answer-badge" *ngIf="answer.isCorrect">✓ Correct</span>
              <div class="answer-actions">
                <button class="btn-icon btn-small" (click)="$event.stopPropagation(); editAnswer(answer)" title="Modifier" type="button" [disabled]="!answer.id">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                  </svg>
                </button>
                <button class="btn-icon btn-small btn-danger" (click)="$event.stopPropagation(); deleteAnswer(answer)" title="Supprimer" type="button" [disabled]="!answer.id">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <button class="btn btn-small btn-secondary" (click)="addAnswer(question)">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 5v14M5 12h14"/>
            </svg>
            Ajouter une réponse
          </button>
        </div>
      </div>

      <div class="no-questions" *ngIf="!test.questions || test.questions.length === 0">
        <p>Aucune question pour ce test</p>
        <button class="btn btn-small" (click)="addQuestion(test)">Ajouter la première question</button>
      </div>
    </div>
  </div>

  <!-- Modal Test -->
  <div class="modal-overlay" *ngIf="showTestModal" (click)="closeTestModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ editingTest ? 'Modifier le test' : 'Créer un test' }}</h2>
        <button class="btn-icon" (click)="closeTestModal()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <form class="modal-body" (ngSubmit)="saveTest()">
        <div class="form-group">
          <label>Formation *</label>
          <select [(ngModel)]="testForm.course" name="course" required>
            <option [value]="null">Sélectionner une formation</option>
            <option *ngFor="let course of courses" [ngValue]="course">{{ course.title }}</option>
          </select>
        </div>
        <div class="form-group">
          <label>Titre *</label>
          <input type="text" [(ngModel)]="testForm.title" name="title" required>
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea [(ngModel)]="testForm.description" name="description" rows="3"></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Score minimum (%) *</label>
            <input type="number" [(ngModel)]="testForm.passingScore" name="passingScore" min="0" max="100" required>
          </div>
          <div class="form-group">
            <label>Durée (minutes) *</label>
            <input type="number" [(ngModel)]="testForm.timeLimit" name="timeLimit" min="1" required>
          </div>
        </div>
        <div class="form-group">
          <label>
            <input type="checkbox" [(ngModel)]="testForm.isActive" name="isActive">
            Test actif
          </label>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeTestModal()">Annuler</button>
          <button type="submit" class="btn btn-primary" [disabled]="loading">Enregistrer</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Question -->
  <div class="modal-overlay" *ngIf="showQuestionModal" (click)="closeQuestionModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ editingQuestion ? 'Modifier la question' : 'Ajouter une question' }}</h2>
        <button class="btn-icon" (click)="closeQuestionModal()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <form class="modal-body" (ngSubmit)="saveQuestion()">
        <div class="form-group">
          <label>Question *</label>
          <textarea [(ngModel)]="questionForm.question" name="question" rows="3" required></textarea>
        </div>
        <div class="form-group">
          <label>Explication (affichée après réponse)</label>
          <textarea [(ngModel)]="questionForm.explanation" name="explanation" rows="2"></textarea>
        </div>
        <div class="form-group">
          <label>Ordre</label>
          <input type="number" [(ngModel)]="questionForm.orderIndex" name="orderIndex" min="0">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeQuestionModal()">Annuler</button>
          <button type="submit" class="btn btn-primary" [disabled]="loading">Enregistrer</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Answer -->
  <div class="modal-overlay" *ngIf="showAnswerModal" (click)="closeAnswerModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ editingAnswer ? 'Modifier la réponse' : 'Ajouter une réponse' }}</h2>
        <button class="btn-icon" (click)="closeAnswerModal()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <form class="modal-body" (ngSubmit)="saveAnswer()" #answerFormRef="ngForm">
        <div class="form-group">
          <label>Réponse *</label>
          <textarea [(ngModel)]="answerForm.text" name="text" rows="2" required #textInput="ngModel"></textarea>
          <div class="error-text" *ngIf="textInput.invalid && textInput.touched">Ce champ est requis</div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Score</label>
            <input type="number" [(ngModel)]="answerForm.score" name="score" step="0.01" min="0" max="100">
          </div>
          <div class="form-group">
            <label>Ordre</label>
            <input type="number" [(ngModel)]="answerForm.orderIndex" name="orderIndex" min="0">
          </div>
        </div>
        <div class="form-group">
          <label>
            <input type="checkbox" [(ngModel)]="answerForm.isCorrect" name="isCorrect">
            Réponse correcte
          </label>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeAnswerModal()">Annuler</button>
          <button type="submit" class="btn btn-primary" [disabled]="loading">Enregistrer</button>
        </div>
      </form>
    </div>
  </div>
</div>
