<div class="placement-test-page">
  <!-- Loading -->
  <div class="loading-state" *ngIf="loading && !test">
    <div class="container">
      <p>Chargement du test...</p>
    </div>
  </div>

  <!-- Error -->
  <div class="error-state" *ngIf="error && !loading">
    <div class="container">
      <p>{{ error }}</p>
      <a routerLink="/catalog" class="btn btn-primary">Retour au catalogue</a>
    </div>
  </div>

  <!-- Test Introduction -->
  <div *ngIf="test && !testStarted && !testCompleted" class="test-intro">
    <div class="container">
      <div class="intro-content">
        <h1>{{ test.title }}</h1>
        <p class="test-description" *ngIf="test.description">{{ test.description }}</p>
        
        <div class="test-info">
          <div class="info-item">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12 6 12 12 16 14"/>
            </svg>
            <span>Durée: {{ test.timeLimit }} minutes</span>
          </div>
          <div class="info-item">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 11l3 3L22 4"/>
              <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
            </svg>
            <span>{{ test.questions?.length || 0 }} questions</span>
          </div>
          <div class="info-item">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 15v2m-6 4h12a2 2 0 0 0 2-2v-6a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2zm10-10V7a4 4 0 0 0-8 0v4h8z"/>
            </svg>
            <span>Score minimum: {{ test.passingScore }}%</span>
          </div>
        </div>

        <div class="test-instructions">
          <h3>Instructions</h3>
          <ul>
            <li>Le test est chronométré. Vous avez {{ test.timeLimit }} minutes pour répondre à toutes les questions.</li>
            <li>Lisez attentivement chaque question avant de répondre.</li>
            <li>Vous pouvez naviguer entre les questions avant de soumettre.</li>
            <li>Une fois le test soumis, vous verrez votre score et pourrez prendre rendez-vous.</li>
          </ul>
        </div>

        <button class="btn btn-primary btn-large" (click)="startTest()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="5 3 19 12 5 21 5 3"/>
          </svg>
          Commencer le test
        </button>
      </div>
    </div>
  </div>

  <!-- Test in Progress -->
  <div *ngIf="test && testStarted && !testCompleted" class="test-in-progress">
    <div class="container">
      <div class="test-header">
        <div class="test-progress">
          <span>Question {{ currentQuestionIndex + 1 }} sur {{ test.questions?.length || 0 }}</span>
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="((currentQuestionIndex + 1) / (test.questions?.length || 1)) * 100"></div>
          </div>
        </div>
        <div class="test-timer" [class.warning]="timeRemaining < 300">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <polyline points="12 6 12 12 16 14"/>
          </svg>
          {{ formatTime(timeRemaining) }}
        </div>
      </div>

      <div class="question-container" *ngIf="getCurrentQuestion()">
        <div class="question">
          <h2>{{ getCurrentQuestion()!.question }}</h2>
        </div>

        <div class="answers">
          <label 
            *ngFor="let answer of getCurrentQuestion()!.answers; let i = index" 
            class="answer-option"
            [class.selected]="answers[getCurrentQuestion()!.id!] === answer.id">
            <input 
              type="radio" 
              [name]="'question-' + getCurrentQuestion()!.id"
              [value]="answer.id"
              [checked]="answers[getCurrentQuestion()!.id!] === answer.id"
              (change)="selectAnswer(getCurrentQuestion()!.id!, answer.id!)">
            <span class="answer-label">{{ String.fromCharCode(65 + i) }}.</span>
            <span class="answer-text">{{ answer.text }}</span>
          </label>
        </div>

        <div class="question-navigation">
          <button 
            class="btn btn-secondary" 
            (click)="previousQuestion()" 
            [disabled]="currentQuestionIndex === 0">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="15 18 9 12 15 6"/>
            </svg>
            Précédent
          </button>
          
          <div class="question-indicators">
            <span 
              *ngFor="let q of test.questions; let i = index"
              class="indicator"
              [class.current]="i === currentQuestionIndex"
              [class.answered]="answers[q.id!]"
              (click)="currentQuestionIndex = i">
              {{ i + 1 }}
            </span>
          </div>

          <button 
            class="btn btn-primary" 
            *ngIf="currentQuestionIndex < (test.questions?.length || 0) - 1"
            (click)="nextQuestion()">
            Suivant
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 18 15 12 9 6"/>
            </svg>
          </button>
          
          <button 
            class="btn btn-primary" 
            *ngIf="currentQuestionIndex === (test.questions?.length || 0) - 1"
            (click)="submitTest()">
            Terminer le test
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Test Results -->
  <div *ngIf="testCompleted && result" class="test-results">
    <div class="container">
      <div class="results-content">
        <div class="results-header" [class.passed]="result.passed" [class.failed]="!result.passed">
          <div class="score-circle">
            <svg *ngIf="result.passed" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
              <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
            <svg *ngIf="!result.passed" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="8" x2="12" y2="12"/>
              <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
          </div>
          <h1>{{ result.passed ? 'Félicitations !' : 'Test terminé' }}</h1>
          <div class="score-display">
            <span class="score-value">{{ result.score.toFixed(1) }}%</span>
            <span class="score-label">Votre score</span>
          </div>
        </div>

        <div class="results-details">
          <div class="detail-item">
            <span class="detail-label">Questions répondues</span>
            <span class="detail-value">{{ result.correctAnswers }} / {{ result.totalQuestions }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Score minimum requis</span>
            <span class="detail-value">{{ test.passingScore }}%</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Statut</span>
            <span class="detail-value" [class.passed]="result.passed" [class.failed]="!result.passed">
              {{ result.passed ? 'Réussi ✓' : 'Non réussi' }}
            </span>
          </div>
        </div>

        <div class="results-message">
          <p *ngIf="result.passed" class="success-message">
            Excellent travail ! Vous avez réussi le test de positionnement. 
            Nous vous recommandons de prendre rendez-vous pour discuter de votre parcours de formation.
          </p>
          <p *ngIf="!result.passed" class="info-message">
            Vous n'avez pas atteint le score minimum requis. 
            Nous vous recommandons de prendre rendez-vous pour discuter de votre niveau et des options de formation adaptées.
          </p>
        </div>

        <div class="results-actions">
          <button class="btn btn-primary btn-large" (click)="goToContact()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            </svg>
            Prendre rendez-vous
          </button>
          <a routerLink="/catalog" class="btn btn-secondary btn-large">
            Retour au catalogue
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
