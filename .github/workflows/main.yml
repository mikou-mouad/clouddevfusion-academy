name: Deploy New Version

on:
  push:
    branches: ["main"]
    paths:
      - "backend/**"
      - "frontend/**"
      - ".github/workflows/main.yml"
  workflow_dispatch: {}


concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      backend_deps: ${{ steps.filter.outputs.backend_deps }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - uses: actions/checkout@v4
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            backend:
              - 'backend/**'
            backend_deps:
              - 'backend/composer.lock'
              - 'backend/composer.json'
            frontend:
              - 'frontend/**'

  deploy-backend:
    name: Deploy Backend (Symfony)
    runs-on: ubuntu-latest
    needs: changes
    # if: ${{ needs.changes.outputs.backend == 'true' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          tools: composer

      - name: Install lftp + curl
        run: |
          sudo apt-get update
          sudo apt-get install -y lftp curl

      - name: Composer install (prod, no scripts)
        working-directory: backend
        run: |
          composer install \
            --no-dev \
            --prefer-dist \
            --no-interaction \
            --optimize-autoloader \
            --no-scripts

      - name: Prepare .env for deployment
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          CORS_ALLOW_ORIGIN: ${{ secrets.CORS_ALLOW_ORIGIN }}
          APP_ENV: prod
          APP_DEBUG: "0"
          APP_SECRET: ${{ secrets.APP_SECRET }}
        run: |
          cat > backend/.env << EOF
          APP_ENV=${APP_ENV}
          APP_DEBUG=${APP_DEBUG}
          APP_SECRET=${APP_SECRET}
          DATABASE_URL=${DATABASE_URL}
          CORS_ALLOW_ORIGIN=${CORS_ALLOW_ORIGIN}
          EOF
          cat backend/.env

      - name: Upload backend files (including .env)
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_PORT: ${{ secrets.FTP_PORT }}
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASS }}
          BACKEND_REMOTE: ${{ secrets.BACKEND_REMOTE }}
        run: |
          lftp -c "
          set ftp:ssl-allow no
          set ftp:passive-mode yes
          set net:timeout 30
          set net:max-retries 3
          open -p ${FTP_PORT} -u '${FTP_USER}','${FTP_PASS}' ${FTP_HOST}
          mkdir -p ${BACKEND_REMOTE}
          cd ${BACKEND_REMOTE}
          mirror -R --only-newer --verbose \
            --exclude-glob='.git*' \
            --exclude-glob='.env.local' \
            --exclude-glob='.env.*.local' \
            --exclude-glob='var/' \
            --exclude-glob='vendor/' \
            --exclude-glob='node_modules/' \
            --exclude-glob='*.log' \
            --exclude-glob='.DS_Store' \
            backend/ ./
          bye
          "

      - name: Upload vendor (only when deps changed)
        if: ${{ needs.changes.outputs.backend_deps == 'true' || github.event_name == 'workflow_dispatch' }}
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_PORT: ${{ secrets.FTP_PORT }}
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASS }}
          BACKEND_REMOTE: ${{ secrets.BACKEND_REMOTE }}
        run: |
          lftp -c "
          set ftp:ssl-allow no
          set ftp:passive-mode yes
          set net:timeout 30
          set net:max-retries 3
          open -p ${FTP_PORT} -u '${FTP_USER}','${FTP_PASS}' ${FTP_HOST}
          mkdir -p ${BACKEND_REMOTE}/vendor
          cd ${BACKEND_REMOTE}/vendor
          mirror -R --only-newer --verbose \
            --exclude-glob='.git*' \
            backend/vendor/ ./
          bye
          "
          
      - name: Clear Symfony cache
        run: |
          sleep 2
          code="$(curl -s -o /dev/null -w "%{http_code}" "https://academy.clouddevfusion.com/backend/public/clear-cache-complete.php" || echo "000")"
          echo "Cache clear HTTP code: $code"
          sleep 2
          
      - name: Verify backend endpoint
        run: |
          code="$(curl -s -o /dev/null -w "%{http_code}" "https://academy.clouddevfusion.com/api/courses" || echo "000")"
          echo "HTTP_CODE=$code"
          if [ "$code" != "200" ] && [ "$code" != "401" ] && [ "$code" != "403" ]; then
            echo "Unexpected backend status: $code"
            exit 1
          fi

  deploy-frontend:
    name: Deploy Frontend (Angular)
    runs-on: ubuntu-latest
    needs: changes 
    # if: ${{ needs.changes.outputs.frontend == 'true' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install lftp + curl
        run: |
          sudo apt-get update
          sudo apt-get install -y lftp curl

      - name: Install deps + build
        working-directory: frontend
        run: |
          npm ci
          npm run build
          test -d dist
          
      - name: Upload dist to FTP (delete removed files)
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_PORT: ${{ secrets.FTP_PORT }}
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASS }}
          FRONTEND_REMOTE: ${{ secrets.FRONTEND_REMOTE }}
        run: |
          lftp -c "
          set ftp:ssl-allow no
          set ftp:passive-mode yes
          set net:timeout 30
          set net:max-retries 3
          open -p ${FTP_PORT} -u '${FTP_USER}','${FTP_PASS}' ${FTP_HOST}
          mkdir -p ${FRONTEND_REMOTE}
          cd ${FRONTEND_REMOTE}
          mirror -R --delete --only-newer --parallel=4 --verbose \
            --exclude-glob='.git*' \
            --exclude-glob='node_modules' \
            --exclude-glob='backend/**' \
            --exclude-glob='.angular' \
            --exclude-glob='*.map' \
            --exclude-glob='*.htaccess' \
            frontend/dist/cloudacademy/browser/ ./
          bye
          "

      - name: Verify frontend (retry)
        run: |
          set -e

          URL="https://academy.clouddevfusion.com"
          MAX_RETRIES=10
          SLEEP_SECONDS=6

          for i in $(seq 1 $MAX_RETRIES); do
            code="$(curl -s -o /dev/null -w "%{http_code}" "$URL" || echo "000")"
            echo "Attempt $i/$MAX_RETRIES â†’ HTTP $code"

            if [ "$code" = "200" ] || [ "$code" = "301" ] || [ "$code" = "302" ]; then
              echo "Frontend is up"
              exit 0
            fi

            if [ "$i" -lt "$MAX_RETRIES" ]; then
              echo "Waiting ${SLEEP_SECONDS}s before retry..."
              sleep "$SLEEP_SECONDS"
            fi
          done

          echo "Frontend did not recover after ${MAX_RETRIES} attempts"
          exit 1
